<html>
  <title>Degrees of Separation</title>
  <head>
    <script src="https://cdn.anychart.com/releases/8.8.0/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.8.0/js/anychart-graph.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.8.0/js/anychart-data-adapter.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

-
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" >

    <style type="text/css">
      html, body,  table {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
       font-family: Raleway, Verdana, Helvetica, Arial, sans-serif;
      }

      #container{
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;

      }

      h1 {
        margin-bottom:5px;
      }

    </style>
  </head>
  <body>
    <table iwidth="100%"><td width="30%" valign="top">
    <div  style="padding-left:15px; padding-right:15px; font-size:24px; margin-bottom:7px; border-bottom:2px dotted #dadada"><i style='font-size:25px' class="fa-solid fa-arrows-split-up-and-left"></i>&nbsp;&nbsp;Degrees of Separation</div>
    <div  style="padding-left:15px; padding-right:15px;   padding-bottom:7px  ">
      Here is a graph of the actors <span class="actor"></span> has worked with.  <span class="findactor"></span>
    </div>

    <div  style="padding-left:15px; padding-right:15px;  padding-bottom:10px  ">
      The game uses a list generated by OpenAI of actors and who they have worked with. OpenAI was trained with data before 2023 so this list 
      might not be up to date. Also OpenAI sometimes gets it wrong. For example it doesn't say that Val Kilmer worked with Bill Bob Thorton when in fact they worked together in Tombstone 
    </div>
    <div  style="padding-left:15px; padding-right:15px; ">
      <input type='text' id="search"/><button id="searchbutton"><i  class="fa fa-search"></i> Lookup actor</button><button style='margin-left:10px' id="giveup" ><i istyle="font-size:30px" class="fa fa-question-circle"></i> I give up</button>
      <div style='font-size:13px' id='msg'></div>
    </div>
     
    <div id="info" style="padding-left:15px; padding-right:15px;  "></div>
    </td><td valign="top">
      <div><span><button id='back'><i class='fa fa-arrow-left'></i> <span id='backactor'></span></button> </span><span style='padding-left:20px' id='title'></span></div>
     <div id="container" ></div>
   
    </td>
    </table>
    <script>
      lastclicked='';
      degrees={};
      seconddegree='';
      findactor='';
      fromactor='';
      steps=[];
      stepscnt=0;
      actor={};

      // First load the degrees json file
      $(document).ready(function() {
        fetch('./degrees.json')
        .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();  
        })
        .then(json => {

        // Have loaded degrees json file
        degrees=json;

        anychart.onDocumentReady(function () {

          // Lookup the actor specified in the search box
          function search()
          {
              if ($("#search").val()) {
                var keys = Object.keys(degrees);
                var actors = keys.map(v => v.toLowerCase());
                actori=$("#search").val().toLowerCase();
                if (actors.includes(actori)) {
                  actorfound=keys[actors.indexOf(actori)];
                  findnewactor(actorfound);
                  loadactor(actorfound);
                } else 
                  $("#msg").html("Could not find the actor <b>"+$("#search").val()+"</b>");
                  
              }
          }

          // Find a random actor that hasn't worked with the specified actor but has worked with someone who has worked with the specified actor
          function findnewactor(actor)
          {

            fromactor=actor;
            steps=[];
            stepscnt=0;
            var keys = Object.keys(degrees);

            // Pick a random person the actor has worked with
            seconddegree=degrees[actor]['workedwith'][degrees[actor]['workedwith'].length * Math.random() << 0];

            // Make sure this random person is in the list of actors in degrees and not just a child
            while (! keys.includes(seconddegree)||seconddegree==actor)  {
              seconddegree=degrees[actor]['workedwith'][degrees[actor]['workedwith'].length * Math.random() << 0];
            }
            console.log("second degree"+seconddegree);

            // Find an actor who has worked with the random actor that hasn't worked with the specified actor
            findactor=degrees[seconddegree]['workedwith'][degrees[seconddegree]['workedwith'].length * Math.random() << 0];
            while (!(keys.includes(findactor)) || findactor==actor || degrees[actor]['workedwith'].includes(findactor)) { 
              findactor=degrees[seconddegree]['workedwith'][degrees[seconddegree]['workedwith'].length * Math.random() << 0];
            }
            console.log("worked with"+actor+" ->"+seconddegree+" ->"+findactor);//findactor);
          }

          // Load the actor
          function loadactor(actorname) {
            $("#container").html('');
            $("#msg").html("");
            $(".actor").html(actorname);
            actor=degrees[actorname];
            data={'nodes':[],'edges':[],"title":{}};
            if (findactor=='') {
              // If haven't picked an actor to find then load one
              findnewactor(actorname);
            }
            
            /*
            {
              "nodes": [
                {
                  "id": "iLannister",
                  "height": 50,
                  "fill": {
                    "src": "img.jpg"
                  }
                },
                {
                  "id": "Tully",
                  "height": 50,
                  "fill": {
                    "src": "img2.jpg"
                  }
                },

              "edges": [
                { "from": "iLannister", "to": "Tully" },
                { "from": "iLannister", "to": "Baratheon" },
                { "from": "Stark", "to": "Lannister" },
                { "from": "iLannister", "to": "Darry" },
                { "from": "Greyjoy", "to": "Stark" },
                { "from": "Stark", "to": "Greyjoy" },
                { "from": "Bolton", "to": "Stark" },
                { "from": "Baratheon", "to": "iLannister" },
                { "from": "Darry", "to": "iLannister" },
                { "from": "Brotherhood without Banners", "to": "Brave Companions" },
                { "from": "iLannister", "to": "Stark" },
                { "from": "iLannister", "to": "Brave Companions" },
                { "from": "Frey", "to": "Stark" },
                { "from": "Frey", "to": "Mallister" },
                { "from": "Free folk", "to": "Night's Watch" },
                { "from": "Free folk", "to": "Baratheon" },
                { "from": "Bolton", "to": "Greyjoy" },
                { "from": "Baratheon", "to": "Greyjoy" },
                { "from": "Greyjoy", "to": "Tyrell" },
                { "from": "Bracken", "to": "Blackwood" },
                { "from": "Baratheon", "to": "Bolton" },
                { "from": "Baratheon", "to": "Frey" }
              ]
              */

              // Display the info about the actor and information about the state of the game
              info='<div style=\"ifont-size: 12px;\" >';
              info+='<div style="font-size:23px; padding-top:15px; margin-bottom:5px; border-bottom:2px dotted #eee">'+actorname+"</div>";//<h2>'+actorname+"</h2>";
              if (actorname==findactor) {
                $(".findactor").html("");//who you've now found");
                info+='<span style="color:black"><i style="font-size:30px" class="fa fa-trophy"></i> <b>Congratulations.</b> You found '+findactor+" in "+stepscnt+" steps.</span><br>";
                if (stepscnt>2) //.length>2)
                  info+='If you had have gone straight from '+fromactor+" to "+seconddegree+" you would have found the person in 1 step.<br><br>";
                else 
                  info+='And you did it in the shortest number of steps.<br><br>';
            
                findnewactor(actorname);  
              info+='<span istyle="color:blue"><i style="font-size:30px" class="fa fa-clock-o"></i><b> Your next task:</b><br>Find the shortest trail from<br> <b>'+fromactor+"</b> to <b>"+findactor+"</b></span><br><br>";

              } else  {
                $(".findactor").html("Find the closest trail from this actor to the actor "+findactor+".");
                info+="<span style='ifont-size:14px'>Can you find the shortest trail from <b>"+fromactor+"</b> to <b>"+ findactor+"</b>?</span><br><br>";

              }
              info+=actor.info;
              info+="</div>";
              $("#info").html(info);
   
              // Create the graph of the actor and who they have worked with
              actori={'id':actorname,'height':200,'fill':{'src':'imageslarge/'+actorname+".jpg"}};
              data['nodes'].push(actori);

              // Do the children that do have an image
              for (child of actor.workedwith) {
                var image = new Image();
                var url_image = 'imagessmall/'+child+".jpg";
                image.src = url_image;
                if (child in degrees|| image.width!=0) {
                  console.log("img"+url_image+" "+image.width);
                  actori={'id':child,'height':50,'fill':{'src':'imagessmall/'+child+".jpg"}};
                  data['nodes'].push (actori);
                }
    
              }

              // Do the children that dont have an image but not if the actor already has too many children
              var   toomany=35;
              for (child of actor.workedwith) {
                var image = new Image();
                var url_image = 'imagessmall/'+child+".jpg";
                image.src = url_image;
                if (!(child in degrees|| image.width!=0) && data['nodes'].length<toomany) {
                  actori={'id':child};
                  data['nodes'].push (actori);
                }
    
              }

              // Create the edges of the graph
              for (child of actor.workedwith) {
                edge={"from":actorname, "to":child};
                data['edges'].push(edge);
              }

              // Highlight the actor you just came from
              if (lastclicked!='') {
                  for (i=0; i<data.nodes.length; i++)
                    if (data.nodes[i].id==lastclicked) {
                        data.nodes[i].normal={stroke:"5 #00aa00"};//, lineJoin: "round"};
                    }
              }
              // Give a hint that have found the actor
              for (i=0; i<data.nodes.length; i++)
                if (data.nodes[i].id==findactor) {
                  data.nodes[i].normal={stroke:"3 #000000"};//, lineJoin: "round"};
                }

              // create a chart from the loaded data
              var chart = anychart.graph(data);

              // Give information on your progress and change back button text
              if (steps.length>0) {
                  $("#back").show();
                  $("#backactor").show();
                  $("#backactor").html("Back to "+steps[steps.length-1]);
              } else  {
                $("#back").hide();
                  $("#backactor").hide();
              }
              if (stepscnt>=1) {//}.length>=1) {
                  $("#title").show();
                  $("#title").html("You have made "+stepscnt+" steps trying to reach <b>"+findactor+"</b> from <b>"+fromactor+"</b>");
              } else {
                  $("#title").hide();

              }

              // access nodes
              var nodes = chart.nodes();
              console.log("node"+data.nodes.length);
              // set the size of nodes
              nodes.normal().height(30);
              nodes.hovered().height(45);
              nodes.selected().height(45);

              // set the stroke of nodes
              nodes.normal().stroke(null);
              nodes.hovered().stroke("#333333", 3);
              nodes.selected().stroke("#333333", 3);

              // enable the labels of nodes
              chart.nodes().labels().enabled(true);

              // configure the labels of nodes
              chart.nodes().labels().format("{%id}");
              chart.nodes().labels().fontSize(12);
              // chart.nodes().labels().fontWeight(600);
              chart.nodes().labels().fontColor("#000");
              chart.nodes().labels().fontFamily("Raleway");
              // draw the chart
              chart.container("container").draw();

              // Click on a new actor
              chart.listen('click', function(e) {
                var tag = e.domTarget.tag;
                // Can only click on actors in the degrees list and only in worked with
                if (tag&&tag.id in degrees&&tag.id!=actorname ) {//data.canclick.includes(tag.id)) {

                  // Fade from old graph to new graph
                  $('#container').fadeOut(/*'fast',*/ function(){
                    console.log(`Clicked ${tag.type} with ID ${tag.id}`);
                    // Record the actor you last clicked
                    lastclicked=actorname; 
                    steps.push(actorname);
                    stepscnt++;
                    // Load the actor the user clicked on
                    loadactor(tag.id);
                    $('#container').fadeIn(/*'fast'*/);
                  });
                  
                }
                
              });               
            }

            // To begin with just pick a random actor
            var keys = Object.keys(degrees);
         
            actor=keys[ keys.length * Math.random() << 0];

            loadactor(actor);

            // Handle back click and take user back to the actor they clicked previously
            $( "#back" ).on( "click", function() {
                if (steps.length>0) {
                setTimeout(() => {
                
                  backactor=steps.pop();
                  if (steps.length>0)
                    lastclicked=steps[steps.length-1];
                  stepscnt++;
                  console.log("iiback actor"+backactor);
                  loadactor(backactor);
                },100);
                }
              
            } );
            // Handle search click or return key
            $('#search').on('keypress', function(e) {
                var code = e.keyCode || e.which;
                if(code==13){             
                  search();
                }
            });
            $( "#searchbutton" ).on( "click", function() {
                search();
            } );

            // Handle user giving up and tell user how to get to the actor
            $( "#giveup" ).on( "click", function() {
                $("#msg").html("Too hard for you? :)<br>"+fromactor+" <i class='fa fa-arrow-right'></i> "+seconddegree+" <i class='fa fa-arrow-right'></i> "+findactor);
            } );
        });
        
        }) 
        .catch(error => console.error('Failed to fetch data:', error)); 

      });


     
  
    </script>
  </body>
</html>